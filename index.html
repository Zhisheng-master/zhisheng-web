<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡³è–ä¿®å¾©å®¤ï½œç·šä¸Šé ç´„</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* æ‚¨åŸæœ¬çš„è³ªæ„Ÿè¨­è¨ˆ */
        :root { --bg-color: #F4F1EA; --card-bg: #FCFAF7; --text-main: #4A403A; --text-sub: #8C7B75; --accent: #7E8C69; --border: #DCD3B2; --input-bg: #FFFFFF; --disabled: #E0E0E0; }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: sans-serif; margin: 0; padding: 20px; }
        .container { max-width: 480px; margin: 40px auto; padding: 40px; background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border); }
        h1 { text-align: center; color: var(--text-main); margin-bottom: 5px; }
        .form-group { margin-bottom: 25px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        select, input { width: 100%; padding: 14px; border: 1px solid var(--border); border-radius: 6px; box-sizing: border-box; background: #fff; }
        .gender-group { display: flex; gap: 15px; }
        .gender-btn { flex: 1; padding: 14px; border: 1px solid var(--border); text-align: center; cursor: pointer; border-radius: 6px; }
        .gender-btn.active { background-color: var(--accent); color: white; }
        button.submit-btn { width: 100%; padding: 18px; background-color: var(--text-main); color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 20px; font-size: 16px; }
        button:disabled { background: #ccc; }
        #loading { text-align: center; display: none; margin-top: 20px; color: var(--accent); }
    </style>
</head>
<body>
    <div class="container">
        <h1>è‡³è–ä¿®å¾©å®¤</h1>
        <hr style="border:0; height:1px; background:var(--accent); margin:20px 0;">
        
        <div class="form-group"><label>1. é¸æ“‡æœå‹™å¸«å‚…</label><select id="master" onchange="onMasterChange()"><option value="">è¼‰å…¥ä¸­...</option></select></div>
        <div class="form-group"><label>2. é¸æ“‡æœå‹™é …ç›®</label><select id="service" disabled><option value="">è«‹å…ˆé¸æ“‡å¸«å‚…</option></select></div>
        <div class="form-group"><label>3. é¸æ“‡æ—¥æœŸ</label><input type="date" id="datePicker" onchange="onDateChange()" disabled></div>
        <div class="form-group"><label>4. é¸æ“‡æ™‚æ®µ</label><select id="timeSlot" disabled><option value="">è«‹å…ˆé¸æ“‡æ—¥æœŸ</option></select></div>
        
        <div class="form-group"><label>5. å§“å</label><input type="text" id="name"></div>
        <div class="form-group"><label>6. é›»è©±</label><input type="tel" id="phone"></div>
        <div class="form-group"><label>7. æ€§åˆ¥</label>
            <div class="gender-group">
                <div class="gender-btn" onclick="selectGender('ç”·', this)">ç”·</div>
                <div class="gender-btn" onclick="selectGender('å¥³', this)">å¥³</div>
            </div>
        </div>

        <button id="submitBtn" class="submit-btn" onclick="submitBooking()">ç¢ºèªé ç´„</button>
        <div id="loading">è™•ç†ä¸­...</div>
    </div>

    <script>
        // ğŸ‘‡ğŸ‘‡ğŸ‘‡ é€™è£¡å¡«å…¥æ‚¨ Apps Script çš„ç¶²å€ (è«‹ç¢ºèªçµå°¾æ˜¯ /exec) ğŸ‘‡ğŸ‘‡ğŸ‘‡
        const API_URL = "https://script.google.com/macros/s/AKfycbxJiZo7EHGyMpn3TtuwmrTriSGF8XwkYnkHT2Cc2cVCut70dEiAa9AUFCVpHvIpD2CT/exec";
        
        // âš ï¸ é€™è£¡å…ˆç•™ç©ºï¼Œç­‰ä¸€ä¸‹ç”³è«‹åˆ°æ–° LIFF ID å†å¡«å›ä¾†
        const MY_LIFF_ID = "2009101750-E9eX0TOT"; 

        let allSchedules = [];
        let globalSettings = { masters: [], services: [] };
        let selectedGender = "";
        let lineUserId = "";

        window.onload = async () => {
            // åˆå§‹åŒ– LIFF (å¦‚æœæœ‰ ID æ‰è·‘)
            if (MY_LIFF_ID !== "LIFF_ID_PLACEHOLDER") {
                try {
                    await liff.init({ liffId: MY_LIFF_ID });
                    if (!liff.isLoggedIn()) liff.login();
                    else lineUserId = (await liff.getProfile()).userId;
                } catch(e) { console.error(e); }
            }

            // æŠ“å–è¨­å®š
            try {
                const res = await fetch(API_URL + "?action=getSettings");
                globalSettings = await res.json();
                const mSel = document.getElementById('master');
                mSel.innerHTML = '<option value="">è«‹é¸æ“‡å¸«å‚…</option>';
                globalSettings.masters.forEach(m => mSel.innerHTML += `<option value="${m}">${m}</option>`);
                
                const schRes = await fetch(API_URL + "?action=getSchedule");
                allSchedules = await schRes.json();
            } catch(e) { alert("é€£ç·š Google å¤±æ•—ï¼Œè«‹ç¢ºèª API ç¶²å€"); }
        };

        function onMasterChange() {
            const m = document.getElementById('master').value;
            const sSel = document.getElementById('service');
            sSel.innerHTML = '<option value="">è«‹é¸æ“‡æœå‹™é …ç›®</option>';
            sSel.disabled = true;
            if (m) {
                const servs = globalSettings.services.filter(s => s.master === m);
                if (servs.length) {
                    servs.forEach(s => sSel.innerHTML += `<option value="${s.name}">${s.name} - $${s.price}</option>`);
                    sSel.disabled = false;
                }
            }
        }
        
        document.getElementById('service').addEventListener('change', (e) => document.getElementById('datePicker').disabled = !e.target.value);

        function onDateChange() {
            const m = document.getElementById('master').value;
            const d = document.getElementById('datePicker').value;
            const tSel = document.getElementById('timeSlot');
            tSel.innerHTML = '<option value="">æœå°‹ä¸­...</option>';
            const slots = allSchedules.filter(s => s.master === m && s.date === d);
            tSel.innerHTML = '<option value="">è«‹é¸æ“‡æ™‚æ®µ</option>';
            if (!slots.length) { tSel.innerHTML = '<option>æœ¬æ—¥å·²æ»¿</option>'; tSel.disabled = true; return; }
            tSel.disabled = false;
            slots.sort((a,b)=>a.time.localeCompare(b.time));
            slots.forEach(s => tSel.innerHTML += `<option value="${s.date}|${s.time}">${s.time}</option>`);
        }

        function selectGender(g, el) { selectedGender = g; document.querySelectorAll('.gender-btn').forEach(b=>b.classList.remove('active')); el.classList.add('active'); }

        async function submitBooking() {
            const n=document.getElementById('name').value;
            const p=document.getElementById('phone').value;
            const m=document.getElementById('master').value;
            const s=document.getElementById('service').value;
            const tv=document.getElementById('timeSlot').value;
            
            if(!n||!p||!m||!s||!tv||!selectedGender) return alert("è«‹å¡«å¯«å®Œæ•´");
            
            // æš«æ™‚æ‹¿æ‰ LIFF ID æª¢æŸ¥ï¼Œè®“æ‚¨å…ˆæ¸¬è©¦è¡¨å–®
            // if(!lineUserId) return alert("è«‹ç”¨ LINE é–‹å•Ÿ");

            document.getElementById('submitBtn').disabled = true;
            document.getElementById('loading').style.display = 'block';
            
            const [d, t] = tv.split('|');
            
            // ğŸ”¥ é—œéµä¿®æ­£ï¼šæ”¹ç”¨æ¨™æº– POSTï¼Œç§»é™¤ no-cors
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ name:n, phone:p, gender:selectedGender, master:m, service:s, date:d, time:t, userId: lineUserId })
                });
                const text = await res.text();
                if(text.includes("Success")) {
                    alert("âœ… é ç´„æˆåŠŸï¼");
                    if(liff.isInClient()) liff.closeWindow();
                    else location.reload();
                } else {
                    alert("å¤±æ•—ï¼š" + text);
                }
            } catch(e) {
                alert("é€£ç·šéŒ¯èª¤ï¼š" + e);
            }
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('loading').style.display = 'none';
        }
    </script>
</body>
</html>